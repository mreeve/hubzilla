version: '3.9'

networks:
  hubzilla:

volumes:
  voldb:
  volweb:

configs:
  nginx_config: 
    file: nginx/nginx.conf
  nginx_default_config:
    file: nginx/default.conf.template
    
services:
  postgres:
    image: postgres:12-alpine
    environment:
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_USER: ${DB_USER}
      POSTGRES_DB: ${DB_NAME}
    volumes:
      - voldb:/var/lib/postgresql/data
    networks:
    - hubzilla

  nginx:
    image: nginx:alpine
    configs:
      - source: nginx_config
        target: /etc/nginx/nginx.conf
      - source: nginx_default_config
        target: /etc/nginx/templates/default.conf.template
    environment:
      NGINX_ENVSUBST_TEMPLATE_SUFFIX: .template
      SERVER_NAME: ${DOMAIN}
    depends_on:
      - hubzilla
    volumes:
      - volweb:/var/www/html
    networks:
      - hubzilla
    ports:
      - 80:80
    deploy:
      labels:
        - traefik.enable=true
        - traefik.http.routers.hubzilla.rule=Host(`${DOMAIN}`)
        - traefik.http.routers.hubzilla.tls=true
        - traefik.http.routers.hubzilla.tls.certresolver=le
        - traefik.http.routers.hubzilla.entrypoints=websecure
        - traefik.http.services.hubzilla.loadbalancer.server.port=80
        - traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https
        - traefik.http.routers.redirect.rule=Host(`${DOMAIN}`)
        - traefik.http.routers.redirect.middlewares=redirect-to-https
        - traefik.http.routers.redirect.entrypoints=web

  hubzilla:
    build:
      context: ../
      dockerfile: Dockerfile
    depends_on:
      - postgres
    env_file: .env
    environment:
      DB_HOST: postgres
      DB_PORT: ${DB_PORT}
      DB_TYPE: ${DB_TYPE}
      DB_NAME: ${DB_NAME}
      DB_USER: ${DB_USER}
      DB_PASSWORD: ${DB_PASSWORD}
      HUBZILLA_DOMAIN: ${DOMAIN}
      HUBZILLA_ADMIN: ${ADMIN_EMAIL}
      ADDON_LIST: ${ADDON_LIST}
    networks:
      - hubzilla
    volumes:
      - volweb:/var/www/html

  cron:
    build:
      context: ../
      dockerfile: Dockerfile
    env_file: .env
    depends_on:
      - postgres
    command: ["crond", "-f"]
    networks:
      - hubzilla
    volumes:
      - volweb:/var/www/html
